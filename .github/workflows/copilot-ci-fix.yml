name: 'Copilot Automation - CI'

permissions:
  contents: read
  pull-requests: write

on:
  workflow_run:
    workflows: ["python-app"] # add workflows here
    types: [completed]

jobs:
  ci-failure:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      # Guard: n'exécuter que si le workflow_run provient du même repo
      - name: Verify event source (same repository)
        run: |
          echo "Event repo: ${{ github.event.workflow_run.head_repository.full_name || github.event.repository.full_name }}"
          if [ "${{ github.event.workflow_run.head_repository.full_name || github.event.repository.full_name }}" != "${{ github.repository }}" ]; then
            echo "Event comes from a different repository. Exiting."
            exit 78  # neutral exit code to skip job
          fi
        shell: bash

      - name: Set up Python (for sanitizer)
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Sanitize PR event and fetch limited diffs
        id: sanitize
        env:
          GITHUB_EVENT_PATH: ${{ github.event_path }}
        run: |
          python .github/scripts/sanitize_ci_event.py
        shell: bash

      - name: Upload sanitized.json for audit
        uses: actions/upload-artifact@v4
        with:
          name: sanitized-pr-payload
          path: sanitized.json

      - name: Run Copilot CLI
        uses: austenstone/copilot-cli@0654510575df6eb7a593dd5cb0f3d9ee494efe52
        with:
          github-token: ${{ secrets.COPILOT_TOKEN }}
          prompt: |
            The GitHub Actions workflow run failed.
            Please analyze the failure and suggest a fix.
            Create a pull request with the necessary changes.
            Include the error logs and any relevant information.

            ## Input Data
            ```json
            ${{ steps.sanitize.outputs.sanitized }}
            ```
