name: 'Copilot Automation - CI'

permissions:
  contents: read
  pull-requests: write

on:
  workflow_run:
    workflows: ["python-app"] # add workflows here
    types: [completed]

jobs:
  ci-failure:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      # Guard: n'exécuter que si le workflow_run provient du même repo
      - name: Verify event source (same repository)
        run: |
          echo "Event repo: ${{ github.event.workflow_run.head_repository.full_name || github.event.repository.full_name }}"
          if [ "${{ github.event.workflow_run.head_repository.full_name || github.event.repository.full_name }}" != "${{ github.repository }}" ]; then
            echo "Event comes from a different repository. Exiting."
            exit 78  # neutral exit code to skip job
          fi
        shell: bash

      # Build a sanitized JSON from the raw event (GITHUB_EVENT_PATH)
      - name: Build sanitized event payload
        id: sanitize
        run: |
          python - <<'PY'
          import json, os, re
          path = os.environ.get('GITHUB_EVENT_PATH')
          if not path:
              print("GITHUB_EVENT_PATH not set", flush=True)
              raise SystemExit(1)
          p = json.load(open(path))

          # Helper: truncate long strings and redact emails/urls
          def clean_str(s, max_len=1000):
              if s is None: return None
              # redact emails and tokens-looking strings
              s = re.sub(r'[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}', '[REDACTED_EMAIL]', s)
              s = re.sub(r'https?://[^\s]+', '[REDACTED_URL]', s)
              if len(s) > max_len:
                  return s[:max_len] + '...[TRUNCATED]'
              return s

          wf = p.get('workflow_run', {})
          repo = p.get('repository', {})
          actor = wf.get('actor') or p.get('sender') or {}

          sanitized = {
              "workflow_run": {
                  "id": wf.get("id"),
                  "name": wf.get("name"),
                  "conclusion": wf.get("conclusion"),
                  "html_url": wf.get("html_url"),
                  "head_branch": clean_str(wf.get("head_branch"), 200),
                  "head_sha": clean_str(wf.get("head_sha"), 200),
                  "run_started_at": wf.get("run_started_at")
              },
              "repository": {
                  "full_name": repo.get("full_name"),
                  "private": repo.get("private", False)
              },
              "actor": {
                  "login": actor.get("login") if isinstance(actor, dict) else clean_str(actor, 200)
              }
          }

          # Convert to single-line compact JSON for safe passing
          compact = json.dumps(sanitized, ensure_ascii=False)
          # Write to file for debugging/inspection
          with open('sanitized.json','w', encoding='utf-8') as f:
              json.dump(sanitized, f, ensure_ascii=False, indent=2)
          # Emit as step output via GITHUB_OUTPUT
          print(f"sanitized<<EOF", file=open(os.environ['GITHUB_OUTPUT'],'a'))
          print(compact, file=open(os.environ['GITHUB_OUTPUT'],'a'))
          print("EOF", file=open(os.environ['GITHUB_OUTPUT'],'a'))
          PY
        shell: bash

      - name: Run Copilot CLI
        uses: austenstone/copilot-cli@0654510575df6eb7a593dd5cb0f3d9ee494efe52
        with:
          github-token: ${{ secrets.COPILOT_TOKEN }}
          prompt: |
            The GitHub Actions workflow run failed.
            Please analyze the failure and suggest a fix.
            Create a pull request with the necessary changes.
            Include the error logs and any relevant information.

            ## Input Data
            ```json
            ${{ steps.sanitize.outputs.sanitized }}
            ```
